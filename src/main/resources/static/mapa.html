<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gestión de Rutas - Google Maps</title>

    <style>
        body {
          margin: 0;
          display: flex;
          height: 100vh;
          font-family: "Poppins", sans-serif;
          background-color: #f5f5f5;
        }

        #sidebar {
          width: 340px;
          background: white;
          border-right: 1px solid #ddd;
          padding: 20px;
          display: flex;
          flex-direction: column;
          gap: 10px;
          box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        }

        #sidebar h2 {
          color: #1565c0;
          text-align: center;
        }

        input, button, select {
          padding: 8px;
          font-size: 14px;
          border-radius: 6px;
          border: 1px solid #ccc;
          width: 100%;
        }

        button {
          background-color: #1e88e5;
          color: white;
          border: none;
          cursor: pointer;
          transition: 0.3s;
        }

        button:hover {
          background-color: #1565c0;
        }

        #map {
          flex: 1;
          height: 100%;
          width: 100%;
        }

        #historial {
          flex: 1;
          overflow-y: auto;
          max-height: 200px;
          border-top: 1px solid #ddd;
          padding-top: 10px;
        }

        .ruta-item {
          background: #f8f9fa;
          padding: 8px;
          border-radius: 5px;
          margin-bottom: 6px;
          cursor: pointer;
        }

        .ruta-item:hover {
          background: #e3f2fd;
        }

        .info-distancia {
          text-align: center;
          margin-top: 5px;
          font-weight: 600;
          color: #333;
        }
    </style>
</head>

<body>
<div id="sidebar">
    <h2>Gestión de Rutas</h2>

    <label>Código de Ruta:</label>
    <input id="codigoRuta" type="text" placeholder="Ej: RUTA-01" />

    <label>ID Conductor:</label>
    <input id="idConductor" type="number" placeholder="Ej: 1" />

    <label>ID Vehículo:</label>
    <input id="idVehiculo" type="number" placeholder="Ej: 1" />

    <label>Login de Usuario:</label>
    <input id="loginUsuario" type="text" placeholder="Ej: admin01" />

    <hr />

    <input id="searchBox" type="text" placeholder="Buscar lugar..." />
    <button id="addStop">Agregar punto</button>
    <button id="drawRoute">Ver ruta y guardar</button>
    <button id="clearLast">Eliminar última ruta</button>
    <button id="clearAll">Limpiar todo</button>
    <div class="info-distancia" id="distanciaTotal">Distancia total: 0 km</div>

    <h3>Historial de rutas</h3>
    <div id="historial"></div>
</div>

<div id="map"></div>

<script async
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB_4kerUw5j7gsmO5qhGK9CxnAxygO7hag&libraries=places&callback=initMap">
</script>

<script>
    let map, directionsService;
    let stops = [];
    let markers = [];
    let rutasGuardadas = [];
    let colorIndex = 0;

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 4.4389, lng: -75.2322 },
        zoom: 13,
      });

      directionsService = new google.maps.DirectionsService();

      const input = document.getElementById("searchBox");
      const autocomplete = new google.maps.places.Autocomplete(input);
      autocomplete.bindTo("bounds", map);

      document.getElementById("addStop").addEventListener("click", () => {
        const place = autocomplete.getPlace();
        if (!place || !place.geometry) {
          alert("Selecciona una ubicación válida.");
          return;
        }
        const location = place.geometry.location;
        stops.push(location);

        const marker = new google.maps.Marker({
          map,
          position: location,
          label: `${stops.length}`,
        });
        markers.push(marker);
        map.panTo(location);
      });

      document.getElementById("drawRoute").addEventListener("click", drawRoute);
      document.getElementById("clearLast").addEventListener("click", clearLastRoute);
      document.getElementById("clearAll").addEventListener("click", clearAll);
    }

    function drawRoute() {
      if (stops.length < 2) {
        alert("Agrega al menos dos puntos.");
        return;
      }

      const codigoRuta = document.getElementById("codigoRuta").value;
      const idConductor = document.getElementById("idConductor").value;
      const idVehiculo = document.getElementById("idVehiculo").value;
      const loginUsuario = document.getElementById("loginUsuario").value;

      if (!codigoRuta || !idConductor || !idVehiculo || !loginUsuario) {
        alert("Por favor, completa todos los campos antes de guardar la ruta.");
        return;
      }

      const waypoints = stops.slice(1, -1).map(loc => ({ location: loc }));
      const request = {
        origin: stops[0],
        destination: stops[stops.length - 1],
        waypoints,
        travelMode: google.maps.TravelMode.DRIVING,
      };

      directionsService.route(request, async (result, status) => {
        if (status === "OK") {
          const color = getColor();
          const path = result.routes[0].overview_path;

          const polyline = new google.maps.Polyline({
            path: path,
            strokeColor: color,
            strokeOpacity: 0.8,
            strokeWeight: 5,
            map: map
          });

          const distance = calcularDistancia(result);
          rutasGuardadas.push({ result, polyline, distance, color });

          mostrarHistorial();
          mostrarDistanciaTotal();

          //  Enviar los trayectos al backend
          const trayectos = stops.map((loc, i) => ({
            ubicacion: `Punto ${i + 1}`,
            ordenParada: i,
            latitud: loc.lat(),
            longitud: loc.lng(),
            loginRegistro: loginUsuario,
            persona: { id: Number(idConductor) },
            vehiculo: { id: Number(idVehiculo) },
            ruta: { codigo: codigoRuta }
          }));

          try {
            const response = await fetch("http://localhost:8080/api/trayectos/guardar", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(trayectos)
            });

            if (response.ok) {
              alert("Ruta guardada correctamente en la base de datos.");
            } else {
              const error = await response.text();
              alert("Error al guardar ruta: " + error);
            }
          } catch (err) {
            alert("Error de conexión con el backend: " + err.message);
          }

          stops = [];
        } else {
          alert("No se pudo generar la ruta.");
        }
      });
    }

    function getColor() {
      const colores = ["#1565C0", "#FF5722", "#4CAF50", "#9C27B0", "#FDD835"];
      const color = colores[colorIndex % colores.length];
      colorIndex++;
      return color;
    }

    function calcularDistancia(result) {
      let total = 0;
      const legs = result.routes[0].legs;
      legs.forEach(l => (total += l.distance.value));
      return (total / 1000).toFixed(2);
    }

    function mostrarHistorial() {
      const historial = document.getElementById("historial");
      historial.innerHTML = "";
      rutasGuardadas.forEach((r, i) => {
        const div = document.createElement("div");
        div.classList.add("ruta-item");
        div.innerHTML = `Ruta ${i + 1} - ${r.distance} km`;
        div.onclick = () => {
          map.fitBounds(new google.maps.LatLngBounds(...r.result.routes[0].overview_path));
        };
        historial.appendChild(div);
      });
    }

    function mostrarDistanciaTotal() {
      const total = rutasGuardadas.reduce((sum, r) => sum + parseFloat(r.distance), 0);
      document.getElementById("distanciaTotal").innerText = `Distancia total: ${total.toFixed(2)} km`;
    }

    function clearLastRoute() {
      const ultima = rutasGuardadas.pop();
      if (ultima) ultima.polyline.setMap(null);
      mostrarHistorial();
      mostrarDistanciaTotal();
    }

    function clearAll() {
      rutasGuardadas.forEach(r => r.polyline.setMap(null));
      rutasGuardadas = [];
      stops = [];
      markers.forEach(m => m.setMap(null));
      markers = [];
      mostrarHistorial();
      mostrarDistanciaTotal();
    }
</script>
</body>
</html>
