<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gesti贸n de Rutas - Google Maps</title>

    <style>
        body {
          margin: 0;
          display: flex;
          height: 100vh;
          font-family: "Poppins", sans-serif;
          background-color: #f5f5f5;
        }

        #sidebar {
          width: 320px;
          background: white;
          border-right: 1px solid #ddd;
          padding: 20px;
          display: flex;
          flex-direction: column;
          gap: 12px;
          box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        }

        #sidebar h2 {
          margin: 0 0 10px 0;
          font-size: 18px;
          color: #1565c0;
          text-align: center;
        }

        input, button, select {
          padding: 8px;
          font-size: 14px;
          border-radius: 6px;
          border: 1px solid #ccc;
          width: 100%;
          box-sizing: border-box;
        }

        button {
          background-color: #1e88e5;
          color: white;
          border: none;
          cursor: pointer;
          transition: 0.3s;
        }

        button:hover {
          background-color: #1565c0;
        }

        #map {
          flex: 1;
          height: 100%;
          width: 100%;
        }

        #historial {
          flex: 1;
          overflow-y: auto;
          max-height: 200px;
          border-top: 1px solid #ddd;
          padding-top: 10px;
        }

        .ruta-item {
          background: #f8f9fa;
          padding: 8px;
          border-radius: 5px;
          margin-bottom: 6px;
          cursor: pointer;
          transition: 0.3s;
        }

        .ruta-item:hover {
          background: #e3f2fd;
        }

        .info-distancia {
          text-align: center;
          margin-top: 5px;
          font-weight: 600;
          color: #333;
        }
    </style>
</head>

<body>
<div id="sidebar">
    <h2> Rastreo de Veh铆culos</h2>

    <input id="searchBox" type="text" placeholder="Buscar lugar..." />
    <button id="addStop">Agregar punto</button>
    <button id="drawRoute">Ver ruta manual</button>
    <button id="clearLast">Eliminar 煤ltima ruta</button>
    <button id="clearAll">Limpiar todo</button>

    <hr />

    <input id="inputCedula" type="text" placeholder="C茅dula del conductor" />
    <button onclick="mostrarRutasConductor()"> Ver rutas del conductor</button>
    <button onclick="mostrarRutasRestringidas()"> Ver rutas restringidas</button>

    <div class="info-distancia" id="distanciaTotal">Distancia total: 0 km</div>

    <h3>Historial de rutas</h3>
    <div id="historial"></div>
</div>

<div id="map"></div>

<script
        async
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB_4kerUw5j7gsmO5qhGK9CxnAxygO7hag&libraries=places&callback=initMap">
</script>

<script>
    let map, directionsService, directionsRenderer;
    let stops = [];
    let markers = [];
    let rutasGuardadas = [];
    let colorIndex = 0;
    let polylines = [];

    // =====================
    //   INICIALIZAR MAPA

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 4.65, lng: -74.1 }, // Bogot谩
        zoom: 13,
      });

      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({ map });

      const input = document.getElementById("searchBox");
      const autocomplete = new google.maps.places.Autocomplete(input);
      autocomplete.bindTo("bounds", map);

      document.getElementById("addStop").addEventListener("click", () => {
        const place = autocomplete.getPlace();
        if (!place || !place.geometry) {
          alert("Selecciona una ubicaci贸n v谩lida.");
          return;
        }
        const location = place.geometry.location;
        stops.push(location);

        const marker = new google.maps.Marker({
          map,
          position: location,
          label: `${stops.length}`,
        });
        markers.push(marker);
        map.panTo(location);
      });

      document.getElementById("drawRoute").addEventListener("click", drawRoute);
      document.getElementById("clearLast").addEventListener("click", clearLastRoute);
      document.getElementById("clearAll").addEventListener("click", clearAll);
    }

    // =====================
    //   RUTA MANUAL (local)
    // =====================
    function drawRoute() {
      if (stops.length < 2) {
        alert("Agrega al menos dos puntos.");
        return;
      }

      const waypoints = stops.slice(1, -1).map(loc => ({ location: loc }));
      const request = {
        origin: stops[0],
        destination: stops[stops.length - 1],
        waypoints,
        travelMode: google.maps.TravelMode.DRIVING,
      };

      directionsService.route(request, (result, status) => {
        if (status === "OK") {
          const polyline = new google.maps.Polyline({
            path: result.routes[0].overview_path,
            strokeColor: getColor(),
            strokeOpacity: 0.8,
            strokeWeight: 5,
            map: map
          });

          const distance = calcularDistancia(result);
          rutasGuardadas.push({ result, polyline, distance });

          mostrarHistorial();
          mostrarDistanciaTotal();
          stops = [];
        } else {
          alert("No se pudo generar la ruta.");
        }
      });
    }

    function getColor() {
      const colores = ["#1565C0", "#FF5722", "#4CAF50", "#9C27B0", "#FDD835"];
      const color = colores[colorIndex % colores.length];
      colorIndex++;
      return color;
    }

    function calcularDistancia(result) {
      let total = 0;
      const legs = result.routes[0].legs;
      legs.forEach(l => (total += l.distance.value));
      return (total / 1000).toFixed(2);
    }

    function mostrarHistorial() {
      const historial = document.getElementById("historial");
      historial.innerHTML = "";
      rutasGuardadas.forEach((r, i) => {
        const div = document.createElement("div");
        div.classList.add("ruta-item");
        div.innerHTML = `Ruta ${i + 1} - ${r.distance} km`;
        div.onclick = () => r.polyline.setMap(map);
        historial.appendChild(div);
      });
    }

    function mostrarDistanciaTotal() {
      const total = rutasGuardadas.reduce((sum, r) => sum + parseFloat(r.distance), 0);
      document.getElementById("distanciaTotal").innerText = `Distancia total: ${total.toFixed(2)} km`;
    }

    function clearLastRoute() {
      const ultima = rutasGuardadas.pop();
      if (ultima) ultima.polyline.setMap(null);
      mostrarHistorial();
      mostrarDistanciaTotal();
    }

    function clearAll() {
      rutasGuardadas.forEach(r => r.polyline.setMap(null));
      rutasGuardadas = [];
      stops = [];
      markers.forEach(m => m.setMap(null));
      markers = [];
      polylines.forEach(p => p.setMap(null));
      polylines = [];
      mostrarHistorial();
      mostrarDistanciaTotal();
    }

    // =====================
    //   RUTAS DESDE BACKEND
    // =====================
    async function mostrarRutasConductor() {
      const cedula = document.getElementById("inputCedula").value;
      if (!cedula) {
        alert("Por favor ingrese el n煤mero de identificaci贸n del conductor");
        return;
      }

      clearAll();
      const response = await fetch(`http://localhost:8080/api/trayectos/conductor/${cedula}`);
      if (!response.ok) {
        alert("No se encontraron rutas para este conductor");
        return;
      }

      const trayectos = await response.json();
      const path = trayectos.map(t => ({ lat: t.latitud, lng: t.longitud }));

      const polyline = new google.maps.Polyline({
        path,
        map,
        strokeColor: "#007bff",
        strokeOpacity: 0.8,
        strokeWeight: 4
      });
      polylines.push(polyline);

      trayectos.forEach(t => {
        const marker = new google.maps.Marker({
          position: { lat: t.latitud, lng: t.longitud },
          map,
          title: `${t.ubicacion} (${t.ruta.codigo})`
        });
        markers.push(marker);
      });

      map.fitBounds(new google.maps.LatLngBounds(...path.map(p => new google.maps.LatLng(p))));
    }

    async function mostrarRutasRestringidas() {
      clearAll();
      const response = await fetch(`http://localhost:8080/api/trayectos/restricciones`);
      if (!response.ok) {
        alert("No hay rutas restringidas");
        return;
      }

      const trayectos = await response.json();
      const path = trayectos.map(t => ({ lat: t.latitud, lng: t.longitud }));

      const polyline = new google.maps.Polyline({
        path,
        map,
        strokeColor: "#ff0000",
        strokeOpacity: 0.8,
        strokeWeight: 4
      });
      polylines.push(polyline);

      trayectos.forEach(t => {
        const marker = new google.maps.Marker({
          position: { lat: t.latitud, lng: t.longitud },
          map,
          icon: "http://maps.google.com/mapfiles/ms/icons/red-dot.png",
          title: `Restricci贸n: ${t.ubicacion}`
        });
        markers.push(marker);
      });

      map.fitBounds(new google.maps.LatLngBounds(...path.map(p => new google.maps.LatLng(p))));
    }
</script>
</body>
</html>
